USE DATABASE FIN_TRADE_EXTRACT;
USE SCHEMA RAW;
USE WAREHOUSE FIN_TRADE_WH;
USE ROLE ETL_ROLE;

CREATE OR REPLACE STAGE FIN_TRADE_EXTRACT.RAW.EARNINGS_CALL_TRANSCRIPT_STAGE
    URL='s3://fin-trade-craft-landing/earnings_call_transcript/'
    STORAGE_INTEGRATION = FIN_TRADE_S3_INTEGRATION
    FILE_FORMAT = (
        TYPE = 'JSON'
        COMPRESSION = 'AUTO'
    );

-- LIST @FIN_TRADE_EXTRACT.RAW.EARNINGS_CALL_TRANSCRIPT_STAGE;


DROP TABLE IF EXISTS FIN_TRADE_EXTRACT.RAW.EARNINGS_CALL_TRANSCRIPT_UNSPLIT;
CREATE TRANSIENT TABLE FIN_TRADE_EXTRACT.RAW.EARNINGS_CALL_TRANSCRIPT_UNSPLIT (
    TRANSCRIPT_DATA VARIANT
);

COPY INTO FIN_TRADE_EXTRACT.RAW.EARNINGS_CALL_TRANSCRIPT_UNSPLIT
FROM (
    SELECT $1 FROM @FIN_TRADE_EXTRACT.RAW.EARNINGS_CALL_TRANSCRIPT_STAGE
)
FILE_FORMAT = (TYPE = 'JSON');


CREATE TABLE IF NOT EXISTS FIN_TRADE_EXTRACT.RAW.EARNINGS_CALL_TRANSCRIPT (
    SYMBOL_ID NUMBER(38, 0),
    QUARTER VARCHAR(20),
    SYMBOL VARCHAR(20),
    SPEAKER STRING,
    TITLE STRING,
    CONTENT STRING,
    SENTIMENT FLOAT
);


MERGE INTO FIN_TRADE_EXTRACT.RAW.EARNINGS_CALL_TRANSCRIPT tgt
USING (
    SELECT
        ABS(HASH(TRANSCRIPT_DATA:symbol::STRING)) % 1000000000 AS symbol_id,
        TRANSCRIPT_DATA:quarter::STRING AS quarter,
        TRANSCRIPT_DATA:symbol::STRING AS symbol,
        transcript_entry.value:speaker::STRING AS speaker,
        transcript_entry.value:title::STRING AS title,
        transcript_entry.value:content::STRING AS content,
        transcript_entry.value:sentiment::FLOAT AS sentiment
    FROM FIN_TRADE_EXTRACT.RAW.EARNINGS_CALL_TRANSCRIPT_UNSPLIT,
         LATERAL FLATTEN(INPUT => TRANSCRIPT_DATA:transcript) transcript_entry
) src
ON tgt.symbol = src.symbol
   AND tgt.quarter = src.quarter
   AND tgt.speaker = src.speaker
   AND tgt.sentiment = src.sentiment
   AND LEFT(tgt.content, 50) = LEFT(src.content, 50)
   AND RIGHT(tgt.content, 50) = RIGHT(src.content, 50)
WHEN NOT MATCHED THEN
    INSERT (
        SYMBOL_ID, QUARTER, SYMBOL, SPEAKER, TITLE, CONTENT, SENTIMENT
    ) VALUES (
        src.symbol_id, src.quarter, src.symbol, src.speaker, src.title, src.content, src.sentiment
    );


