
USE DATABASE FIN_TRADE_EXTRACT;
CREATE OR REPLACE TRANSIENT TABLE EARNINGS_CALL_TRANSCRIPT_STAGING (
    SYMBOL VARCHAR(20),
    QUARTER VARCHAR(8),
    TRANSCRIPT_DATE VARCHAR(32),
    TRANSCRIPT_TEXT STRING,
    SPEAKER STRING,
    ROLE STRING,
    SENTIMENT VARCHAR(32)
);
USE WAREHOUSE FIN_TRADE_WH;
USE ROLE ETL_ROLE;
CREATE OR REPLACE STAGE FIN_TRADE_EXTRACT.RAW.EARNINGS_CALL_TRANSCRIPT_STAGE;

LIST @EARNINGS_CALL_TRANSCRIPT_STAGE;
CREATE TABLE IF NOT EXISTS FIN_TRADE_EXTRACT.RAW.EARNINGS_CALL_TRANSCRIPT (
CREATE TABLE IF NOT EXISTS FIN_TRADE_EXTRACT.RAW.EARNINGS_CALL_TRANSCRIPT (
    SYMBOL VARCHAR(20) NOT NULL,
    QUARTER VARCHAR(8) NOT NULL,
    TRANSCRIPT_DATE DATE,
    TRANSCRIPT_TEXT STRING,
    SPEAKER STRING,
CREATE OR REPLACE STAGE FIN_TRADE_EXTRACT.RAW.EARNINGS_CALL_TRANSCRIPT_STAGE
        URL='s3://fin-trade-craft-landing/earnings_call_transcript/'
        STORAGE_INTEGRATION = FIN_TRADE_S3_INTEGRATION
        FILE_FORMAT = (
                TYPE = 'CSV'
                COMPRESSION = 'AUTO'
                FIELD_DELIMITER = ','
                RECORD_DELIMITER = '\n'
                SKIP_HEADER = 1
                NULL_IF = ('NULL', 'null', '', 'None')
                EMPTY_FIELD_AS_NULL = TRUE
                FIELD_OPTIONALLY_ENCLOSED_BY = '"'
                TRIM_SPACE = TRUE
                ERROR_ON_COLUMN_COUNT_MISMATCH = FALSE
                ENCODING = 'UTF8'
        );
LIST @FIN_TRADE_EXTRACT.RAW.EARNINGS_CALL_TRANSCRIPT_STAGE;
        s.QUARTER,
        TRY_TO_DATE(s.TRANSCRIPT_DATE) AS TRANSCRIPT_DATE,
        s.TRANSCRIPT_TEXT,
        s.SPEAKER,
        s.ROLE,
        TRY_CAST(s.SENTIMENT AS FLOAT) AS SENTIMENT,
        CURRENT_TIMESTAMP() AS LOAD_DATE
    FROM EARNINGS_CALL_TRANSCRIPT_STAGING s
    WHERE s.SYMBOL IS NOT NULL AND s.QUARTER IS NOT NULL
) AS source
ON target.SYMBOL = source.SYMBOL AND target.QUARTER = source.QUARTER
WHEN MATCHED THEN
    UPDATE SET
        target.TRANSCRIPT_DATE = source.TRANSCRIPT_DATE,
        target.TRANSCRIPT_TEXT = source.TRANSCRIPT_TEXT,
        target.SPEAKER = source.SPEAKER,
        target.ROLE = source.ROLE,
        target.SENTIMENT = source.SENTIMENT,
        target.LOAD_DATE = source.LOAD_DATE
WHEN NOT MATCHED THEN
    INSERT (
        SYMBOL, QUARTER, TRANSCRIPT_DATE, TRANSCRIPT_TEXT, SPEAKER, ROLE, SENTIMENT, LOAD_DATE
    )
    VALUES (
        source.SYMBOL, source.QUARTER, source.TRANSCRIPT_DATE, source.TRANSCRIPT_TEXT, source.SPEAKER, source.ROLE, source.SENTIMENT, source.LOAD_DATE
    );
DROP TABLE IF EXISTS FIN_TRADE_EXTRACT.RAW.EARNINGS_CALL_TRANSCRIPT_STAGING;
DROP TABLE IF EXISTS EARNINGS_CALL_TRANSCRIPT_STAGING;

SELECT 
    'Total Earnings Call Transcripts' as metric,
FROM FIN_TRADE_EXTRACT.RAW.EARNINGS_CALL_TRANSCRIPT
FROM EARNINGS_CALL_TRANSCRIPT
UNION ALL
SELECT 
    'Unique Symbols',
FROM FIN_TRADE_EXTRACT.RAW.EARNINGS_CALL_TRANSCRIPT;
FROM EARNINGS_CALL_TRANSCRIPT;
