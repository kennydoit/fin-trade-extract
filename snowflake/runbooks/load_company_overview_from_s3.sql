-- DEBUG VERSION: Load company overview CSV files to see actual structure
-- This version focuses on getting ANY data loaded first, then we can optimize

USE DATABASE FIN_TRADE_EXTRACT;
USE SCHEMA RAW;
USE WAREHOUSE FIN_TRADE_WH;
USE ROLE ACCOUNTADMIN;

-- 1) Create stage if needed
CREATE STAGE IF NOT EXISTS FIN_TRADE_EXTRACT.RAW.COMPANY_OVERVIEW_STAGE
  URL='s3://fin-trade-craft-landing/company_overview/'
  STORAGE_INTEGRATION = FIN_TRADE_S3_INTEGRATION;

-- 2) Create staging table with proper Alpha Vantage field names - ALL VARCHAR to avoid type issues
CREATE OR REPLACE TRANSIENT TABLE FIN_TRADE_EXTRACT.RAW.COMPANY_OVERVIEW_STAGING (
  -- Core identification
  SYMBOL VARCHAR(500),
  
  -- Company info (matching Alpha Vantage API response keys)
  ASSETTYPE VARCHAR(500),
  NAME VARCHAR(500),
  DESCRIPTION VARCHAR(1000),
  CIK VARCHAR(500),
  EXCHANGE VARCHAR(500),
  CURRENCY VARCHAR(500),
  COUNTRY VARCHAR(500),
  SECTOR VARCHAR(500),
  INDUSTRY VARCHAR(500),
  ADDRESS VARCHAR(1000),
  OFFICIALSITE VARCHAR(500),
  
  -- Key fiscal fields you mentioned
  FISCALYEAREND VARCHAR(500),
  LATESTQUARTER VARCHAR(500),
  
  -- Financial metrics (all VARCHAR to avoid type conversion issues)
  MARKETCAPITALIZATION VARCHAR(500),
  EBITDA VARCHAR(500),
  PERATIO VARCHAR(500),
  PEGRATIO VARCHAR(500),
  BOOKVALUE VARCHAR(500),
  DIVIDENDPERSHARE VARCHAR(500),
  DIVIDENDYIELD VARCHAR(500),
  EPS VARCHAR(500),
  REVENUPERSHARETTM VARCHAR(500),
  PROFITMARGIN VARCHAR(500),
  OPERATINGMARGINTTM VARCHAR(500),
  RETURNONASSETSTTM VARCHAR(500),
  RETURNONEQUITYTTM VARCHAR(500),
  REVENUETTM VARCHAR(500),
  GROSSPROFITTTM VARCHAR(500),
  DILUTEDEPSTTM VARCHAR(500),
  QUARTERLYEARNINGSGROWTHYOY VARCHAR(500),
  QUARTERLYREVENUEGROWTHYOY VARCHAR(500),
  ANALYSTTARGETPRICE VARCHAR(500),
  TRAILINGPE VARCHAR(500),
  FORWARDPE VARCHAR(500),
  PRICETOSALESRATIOTTM VARCHAR(500),
  PRICETOBOOKRATIO VARCHAR(500),
  EVTOREVENUE VARCHAR(500),
  EVTOEBITDA VARCHAR(500),
  BETA VARCHAR(500),
  
  -- Price data
  "52WEEKHIGH" VARCHAR(500),
  "52WEEKLOW" VARCHAR(500),
  "50DAYMOVINGAVERAGE" VARCHAR(500),
  "200DAYMOVINGAVERAGE" VARCHAR(500),
  SHARESOUTSTANDING VARCHAR(500),
  
  -- Dividend dates
  DIVIDENDDATE VARCHAR(500),
  EXDIVIDENDDATE VARCHAR(500),
  
  -- Processing metadata (added by Python script)
  SYMBOL_ID VARCHAR(500),
  PROCESSED_DATE VARCHAR(500),
  LOAD_DATE VARCHAR(500),
  
  -- File tracking
  source_file VARCHAR(500)
);

-- Debug: Check what files are in the stage
SELECT 'Files in S3 stage:' as MESSAGE;
LIST @COMPANY_OVERVIEW_STAGE;

-- Debug: Check if RAW_CSV_FORMAT exists
SHOW FILE FORMATS LIKE 'RAW_CSV_FORMAT';

-- Load CSV files directly using proper column names
COPY INTO FIN_TRADE_EXTRACT.RAW.COMPANY_OVERVIEW_STAGING 
FROM @COMPANY_OVERVIEW_STAGE
FILE_FORMAT = (
  TYPE = 'CSV',
  FIELD_DELIMITER = ',',
  RECORD_DELIMITER = '\n',
  SKIP_HEADER = 1,
  FIELD_OPTIONALLY_ENCLOSED_BY = '"',
  ESCAPE = '\\',
  NULL_IF = ('', 'NULL', 'null', 'None'),
  EMPTY_FIELD_AS_NULL = TRUE,
  ERROR_ON_COLUMN_COUNT_MISMATCH = FALSE
)
PATTERN = 'overview_.*\\.csv'
ON_ERROR = CONTINUE;

-- Debug: Check load results
SELECT 'Load Results:' as MESSAGE;

SELECT 
    'Total rows loaded:' as METRIC,
    COUNT(*) as VALUE
FROM FIN_TRADE_EXTRACT.RAW.COMPANY_OVERVIEW_STAGING;

SELECT 
    'Files processed:' as METRIC,
    COUNT(DISTINCT source_file) as VALUE
FROM FIN_TRADE_EXTRACT.RAW.COMPANY_OVERVIEW_STAGING;

-- Show files and row counts
SELECT 
    source_file,
    COUNT(*) as rows_per_file
FROM FIN_TRADE_EXTRACT.RAW.COMPANY_OVERVIEW_STAGING 
GROUP BY source_file
ORDER BY source_file;

-- Show sample data with proper column names
SELECT 'Core company information:' as MESSAGE;
SELECT 
    SYMBOL, NAME, EXCHANGE, ASSETTYPE, COUNTRY, SECTOR, INDUSTRY,
    source_file
FROM FIN_TRADE_EXTRACT.RAW.COMPANY_OVERVIEW_STAGING 
LIMIT 3;

-- Show key fiscal fields you mentioned
SELECT 'Key fiscal data fields:' as MESSAGE;
SELECT 
    SYMBOL, FISCALYEAREND, LATESTQUARTER, MARKETCAPITALIZATION,
    source_file
FROM FIN_TRADE_EXTRACT.RAW.COMPANY_OVERVIEW_STAGING 
LIMIT 3;

-- Show financial metrics
SELECT 'Financial metrics sample:' as MESSAGE;
SELECT 
    SYMBOL, PERATIO, EPS, PROFITMARGIN, BETA, 
    "52WEEKHIGH", "52WEEKLOW",
    source_file
FROM FIN_TRADE_EXTRACT.RAW.COMPANY_OVERVIEW_STAGING 
LIMIT 3;

-- Show processing metadata
SELECT 'Processing metadata:' as MESSAGE;
SELECT 
    SYMBOL, SYMBOL_ID, PROCESSED_DATE, LOAD_DATE,
    source_file
FROM FIN_TRADE_EXTRACT.RAW.COMPANY_OVERVIEW_STAGING 
LIMIT 3;

-- Check for data completeness in key fields
SELECT 'Data completeness analysis:' as MESSAGE;
SELECT 
    COUNT(*) as total_rows,
    COUNT(SYMBOL) as symbols_with_data,
    COUNT(FISCALYEAREND) as fiscal_year_end_populated,
    COUNT(LATESTQUARTER) as latest_quarter_populated,
    COUNT(MARKETCAPITALIZATION) as market_cap_populated,
    COUNT(NAME) as company_name_populated
FROM FIN_TRADE_EXTRACT.RAW.COMPANY_OVERVIEW_STAGING;

-- NO DELETE STATEMENTS - KEEP ALL DATA FOR DEBUGGING

SELECT 'Debug staging table created successfully! Check the output above to understand the CSV structure.' as COMPLETION_MESSAGE;

-- Do NOT drop the staging table
SELECT 'Staging table preserved for debugging' as PRESERVATION_MESSAGE;