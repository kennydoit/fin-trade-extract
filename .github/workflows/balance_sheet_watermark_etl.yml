name: Balance Sheet ETL - Watermark Based

on:
  workflow_dispatch:
    inputs:
      exchange_filter:
        description: 'Exchange to process (NYSE, NASDAQ, or leave blank for all)'
        required: false
        type: choice
        options:
          - ''
          - NYSE
          - NASDAQ
          - AMEX
        default: ''
      max_symbols:
        description: 'Maximum number of symbols to process (blank = all eligible symbols)'
        required: false
        type: number
      skip_recent_hours:
        description: 'Skip symbols processed within this many hours (blank = re-process all)'
        required: false
        type: number
      batch_size:
        description: 'Number of symbols to process per batch'
        required: false
        type: number
        default: 50
      consecutive_failure_threshold:
        description: 'Omit symbols with how many consecutive failures?'
        required: false
        type: number
        default: 3

jobs:
  watermark-balance-sheet-etl:
    runs-on: ubuntu-22.04
    timeout-minutes: 360  # 6 hours max
    permissions:
      id-token: write
      contents: read
    env:
      # (add any global environment variables here if needed)
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Decode Snowflake private key
        run: echo "${{ secrets.SNOWFLAKE_PRIVATE_KEY_DER_B64 }}" | base64 -d > snowflake_rsa_key.der
        working-directory: ${{ github.workspace }}

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install boto3 requests snowflake-connector-python

      - name: Configure AWS credentials (OIDC)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_TO_ASSUME }}
          aws-region: ${{ secrets.AWS_REGION }}

      - name: Fetch balance sheet data using watermarks
        working-directory: ${{ github.workspace }}
        env:
          ALPHAVANTAGE_API_KEY: ${{ secrets.ALPHAVANTAGE_API_KEY }}
          AWS_REGION: ${{ secrets.AWS_REGION }}
          S3_BUCKET: fin-trade-craft-landing
          S3_BALANCE_SHEET_PREFIX: balance_sheet/
          SNOWFLAKE_ACCOUNT: ${{ secrets.SNOWFLAKE_ACCOUNT }}
          SNOWFLAKE_USER: ${{ secrets.SNOWFLAKE_USER }}
          SNOWFLAKE_WAREHOUSE: ${{ secrets.SNOWFLAKE_WAREHOUSE }}
          SNOWFLAKE_DATABASE: ${{ secrets.SNOWFLAKE_DATABASE }}
          SNOWFLAKE_SCHEMA: ${{ secrets.SNOWFLAKE_SCHEMA }}
          EXCHANGE_FILTER: ${{ inputs.exchange_filter }}
          MAX_SYMBOLS: ${{ inputs.max_symbols }}
          SKIP_RECENT_HOURS: ${{ inputs.skip_recent_hours }}
          BATCH_SIZE: ${{ inputs.batch_size || '50' }}
          CONSECUTIVE_FAILURE_THRESHOLD: ${{ inputs.consecutive_failure_threshold || '3' }}
        run: |
          echo "üöÄ Starting watermark-based balance sheet ETL..."
          if [ -n "$EXCHANGE_FILTER" ]; then
            echo "üè¢ Exchange filter: $EXCHANGE_FILTER"
          else
            echo "üåê Processing: All exchanges"
          fi
          if [ -n "$MAX_SYMBOLS" ]; then
            echo "üîí Symbol limit: $MAX_SYMBOLS symbols (testing mode)"
          else
            echo "üìä Processing: All eligible symbols from watermarks"
          fi
          if [ -n "$SKIP_RECENT_HOURS" ]; then
            echo "‚è≠Ô∏è  Skip recent: Symbols processed within $SKIP_RECENT_HOURS hours will be skipped"
          else
            echo "üîÑ Re-process: All eligible symbols will be processed"
          fi
          echo "üìã Batch size: $BATCH_SIZE symbols"
          echo ""
          echo "üìç Balance Sheet Logic:"
          echo "  - Only active common stocks (ASSET_TYPE='Stock' AND STATUS='Active')"
            echo "  - Annual + Quarterly reports from Alpha Vantage API"
            echo "  - Update watermarks with fiscal date range"
            echo "  - Mark delisted stocks as 'DEL' after successful extraction"
            echo ""
            python scripts/etl/fetch_balance_sheet_watermark.py


      - name: Load balance sheet data into Snowflake
        working-directory: ${{ github.workspace }}
        env:
          SNOWFLAKE_ACCOUNT: ${{ secrets.SNOWFLAKE_ACCOUNT }}
          SNOWFLAKE_USER: ${{ secrets.SNOWFLAKE_USER }}
          SNOWFLAKE_WAREHOUSE: ${{ secrets.SNOWFLAKE_WAREHOUSE }}
          SNOWFLAKE_DATABASE: ${{ secrets.SNOWFLAKE_DATABASE }}
          SNOWFLAKE_SCHEMA: ${{ secrets.SNOWFLAKE_SCHEMA }}
        run: |
          echo "üóÑÔ∏è Loading balance sheet data into Snowflake..."
          python scripts/github_actions/snowflake_run_sql_file.py snowflake/runbooks/load_balance_sheet_from_s3.sql

      - name: Clean up private key
        run: rm -f snowflake_rsa_key.der
        working-directory: ${{ github.workspace }}

      - name: Upload processing results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: watermark-etl-results-${{ github.run_number }}
          path: /tmp/watermark_etl_results.json
          retention-days: 30

