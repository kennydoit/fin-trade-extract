name: Listing Status ETL

on:
  workflow_dispatch:
    inputs:
      delisted_date:
        description: 'Date for delisted stocks (YYYY-MM-DD format, optional - defaults to 1 year ago)'
        required: false
        type: string
  schedule:
    - cron: '0 6 * * *'  # Daily at 6 AM UTC

jobs:
  listing-status-etl:
    runs-on: ubuntu-22.04
    permissions:
      id-token: write
      contents: read
    env:
      PYTHONUNBUFFERED: '1'
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r scripts/github_actions/requirements.txt

      - name: Configure AWS credentials (OIDC)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_TO_ASSUME }}
          aws-region: ${{ secrets.AWS_REGION }}

      - name: Fetch LISTING_STATUS (Active & Delisted) and upload to S3
        env:
          ALPHAVANTAGE_API_KEY: ${{ secrets.ALPHAVANTAGE_API_KEY }}
          AWS_REGION: ${{ secrets.AWS_REGION }}
          S3_BUCKET: fin-trade-craft-landing
          S3_LISTING_STATUS_PREFIX: listing_status/
          DELISTED_DATE: ${{ github.event.inputs.delisted_date }}
        run: |
          echo "üöÄ Starting enhanced listing status extraction..."
          echo "üìà Fetching active (listed) stocks"
          echo "üìâ Fetching delisted stocks"
          if [ -n "$DELISTED_DATE" ]; then
            echo "üóìÔ∏è Using custom delisted date: $DELISTED_DATE"
          else
            echo "üóìÔ∏è Using default delisted date (1 year ago)"
          fi
          python scripts/github_actions/fetch_listing_status_to_s3.py

      - name: Load LISTING_STATUS into Snowflake
        env:
          SNOWFLAKE_ACCOUNT: ${{ secrets.SNOWFLAKE_ACCOUNT }}
          SNOWFLAKE_USER: ${{ secrets.SNOWFLAKE_USER }}
          SNOWFLAKE_PASSWORD: ${{ secrets.SNOWFLAKE_PASSWORD }}
          SNOWFLAKE_WAREHOUSE: ${{ secrets.SNOWFLAKE_WAREHOUSE }}
          SNOWFLAKE_DATABASE: ${{ secrets.SNOWFLAKE_DATABASE }}
          SNOWFLAKE_SCHEMA: ${{ secrets.SNOWFLAKE_SCHEMA }}
        run: |
          python scripts/github_actions/snowflake_run_sql_file.py snowflake/runbooks/load_listing_status_from_s3.sql
