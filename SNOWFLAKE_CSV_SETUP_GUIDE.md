# Snowflake CSV Data Loading Setup Guide

This guide walks through setting up Snowflake to automatically load CSV data generated by Lambda functions.

## Prerequisites

- Snowflake account with ACCOUNTADMIN privileges
- AWS account with access to S3 bucket `fin-trade-craft-landing`
- Lambda functions deployed and generating CSV files

## Step-by-Step Setup

### Step 1: Setup Snowflake Database and Schema

```sql
-- Run this in Snowflake Web UI or SnowSQL
\i snowflake/schema/01_database_setup_csv.sql
```

**What this does:**
- Creates `FIN_TRADE_EXTRACT` database
- Creates `RAW`, `PROCESSED`, `ANALYTICS` schemas
- Creates cost-optimized warehouse `FIN_TRADE_WH`
- Creates CSV file format for Lambda-generated files

### Step 2: Create Tables for CSV Data

```sql
-- Run this in Snowflake Web UI or SnowSQL
\i snowflake/schema/02_tables_csv.sql
```

**What this does:**
- Creates tables matching CSV column structure exactly:
  - `OVERVIEW` - Company fundamental data
  - `TIME_SERIES_DAILY_ADJUSTED` - Stock price data
  - `INCOME_STATEMENT` - Income statement data
  - `BALANCE_SHEET` - Balance sheet data  
  - `CASH_FLOW` - Cash flow data
- Optimizes tables with clustering for query performance

### Step 3: Create Storage Integration and External Stages

**First, create the storage integration:**

```sql
-- Run this in Snowflake Web UI or SnowSQL
\i snowflake/schema/03_storage_integration_csv.sql
```

**Get Snowflake credentials for AWS:**

```sql
-- Run this and save the output
DESC STORAGE INTEGRATION FIN_TRADE_S3_INTEGRATION;
```

**Note down these values:**
- `STORAGE_AWS_IAM_USER_ARN` 
- `STORAGE_AWS_EXTERNAL_ID`

### Step 4: Create AWS IAM Role for Snowflake

Run these AWS CLI commands to create the IAM role:

```bash
# Create trust policy file
cat > snowflake-trust-policy.json << 'EOF'
{
    "Version": "2012-10-17",
    "Statement": [
        {
            "Effect": "Allow",
            "Principal": {
                "AWS": "YOUR_STORAGE_AWS_IAM_USER_ARN"
            },
            "Action": "sts:AssumeRole",
            "Condition": {
                "StringEquals": {
                    "sts:ExternalId": "YOUR_STORAGE_AWS_EXTERNAL_ID"
                }
            }
        }
    ]
}
EOF

# Create S3 access policy file
cat > snowflake-s3-policy.json << 'EOF'
{
    "Version": "2012-10-17",
    "Statement": [
        {
            "Effect": "Allow",
            "Action": [
                "s3:GetObject",
                "s3:GetObjectVersion",
                "s3:ListBucket"
            ],
            "Resource": [
                "arn:aws:s3:::fin-trade-craft-landing",
                "arn:aws:s3:::fin-trade-craft-landing/*"
            ]
        }
    ]
}
EOF

# Create IAM role
aws iam create-role --role-name SnowflakeS3AccessRole --assume-role-policy-document file://snowflake-trust-policy.json

# Attach policy to role
aws iam put-role-policy --role-name SnowflakeS3AccessRole --policy-name SnowflakeS3Access --policy-document file://snowflake-s3-policy.json
```

**Update the storage integration with the role ARN:**

```sql
ALTER STORAGE INTEGRATION FIN_TRADE_S3_INTEGRATION 
SET STORAGE_AWS_ROLE_ARN = 'arn:aws:iam::441691361831:role/SnowflakeS3AccessRole';
```

### Step 5: Create Snowpipes for Automatic Loading

```sql
-- Run this in Snowflake Web UI or SnowSQL  
\i snowflake/schema/04_snowpipes_csv.sql
```

**Get notification channel ARNs:**

```sql
SELECT 
    PIPE_NAME,
    NOTIFICATION_CHANNEL
FROM TABLE(INFORMATION_SCHEMA.PIPES) 
WHERE PIPE_SCHEMA = 'RAW'
ORDER BY PIPE_NAME;
```

### Step 6: Configure S3 Bucket Event Notifications

Create S3 event notifications to trigger Snowpipes:

```bash
# Create bucket notification configuration
cat > bucket-notifications.json << 'EOF'
{
    "QueueConfigurations": [
        {
            "Id": "overview-pipe-notification",
            "QueueArn": "YOUR_OVERVIEW_PIPE_NOTIFICATION_CHANNEL",
            "Events": ["s3:ObjectCreated:Put", "s3:ObjectCreated:Post"],
            "Filter": {
                "Key": {
                    "FilterRules": [
                        {"Name": "prefix", "Value": "overview/"},
                        {"Name": "suffix", "Value": ".csv"}
                    ]
                }
            }
        },
        {
            "Id": "time-series-pipe-notification", 
            "QueueArn": "YOUR_TIME_SERIES_PIPE_NOTIFICATION_CHANNEL",
            "Events": ["s3:ObjectCreated:Put", "s3:ObjectCreated:Post"],
            "Filter": {
                "Key": {
                    "FilterRules": [
                        {"Name": "prefix", "Value": "time-series/"},
                        {"Name": "suffix", "Value": ".csv"}
                    ]
                }
            }
        },
        {
            "Id": "income-statement-pipe-notification",
            "QueueArn": "YOUR_INCOME_STATEMENT_PIPE_NOTIFICATION_CHANNEL", 
            "Events": ["s3:ObjectCreated:Put", "s3:ObjectCreated:Post"],
            "Filter": {
                "Key": {
                    "FilterRules": [
                        {"Name": "prefix", "Value": "income-statement/"},
                        {"Name": "suffix", "Value": ".csv"}
                    ]
                }
            }
        },
        {
            "Id": "balance-sheet-pipe-notification",
            "QueueArn": "YOUR_BALANCE_SHEET_PIPE_NOTIFICATION_CHANNEL",
            "Events": ["s3:ObjectCreated:Put", "s3:ObjectCreated:Post"],
            "Filter": {
                "Key": {
                    "FilterRules": [
                        {"Name": "prefix", "Value": "balance-sheet/"},
                        {"Name": "suffix", "Value": ".csv"}
                    ]
                }
            }
        },
        {
            "Id": "cash-flow-pipe-notification",
            "QueueArn": "YOUR_CASH_FLOW_PIPE_NOTIFICATION_CHANNEL",
            "Events": ["s3:ObjectCreated:Put", "s3:ObjectCreated:Post"],
            "Filter": {
                "Key": {
                    "FilterRules": [
                        {"Name": "prefix", "Value": "cash-flow/"},
                        {"Name": "suffix", "Value": ".csv"}
                    ]
                }
            }
        }
    ]
}
EOF

# Apply notification configuration
aws s3api put-bucket-notification-configuration --bucket fin-trade-craft-landing --notification-configuration file://bucket-notifications.json
```

### Step 7: Test the Pipeline

1. **Test existing data:**

```sql
-- Check if existing CSV file can be loaded
LIST @OVERVIEW_STAGE;

-- Manual load test
SELECT $1, $2, $3, $4, $5 FROM @OVERVIEW_STAGE/aws-test-005_2025-09-26T18:35:00Z.csv LIMIT 5;
```

2. **Run Lambda function to generate new data:**

```bash
# Test Lambda function
aws lambda invoke --function-name fin-trade-overview-extractor --payload '{"symbols": ["MSFT"], "run_id": "snowflake-test-001"}' response.json
```

3. **Verify automatic loading:**

```sql
-- Check if data loaded automatically
SELECT COUNT(*) FROM OVERVIEW;
SELECT * FROM OVERVIEW ORDER BY LOADED_AT DESC LIMIT 5;

-- Check pipe status
SELECT SYSTEM$PIPE_STATUS('OVERVIEW_PIPE');
```

## Monitoring and Troubleshooting

### Check Pipe Status

```sql
-- View pipe execution history
SELECT * FROM TABLE(INFORMATION_SCHEMA.COPY_HISTORY(
    TABLE_NAME=>'OVERVIEW', 
    START_TIME=> DATEADD(hours, -24, CURRENT_TIMESTAMP())
));

-- Check for errors
SELECT * FROM TABLE(INFORMATION_SCHEMA.COPY_HISTORY(
    TABLE_NAME=>'OVERVIEW', 
    START_TIME=> DATEADD(hours, -24, CURRENT_TIMESTAMP())
)) 
WHERE STATUS = 'LOAD_FAILED';
```

### Manual Pipe Refresh

```sql
-- If automatic loading isn't working, manually refresh pipe
ALTER PIPE OVERVIEW_PIPE REFRESH;
```

### View Table Data

```sql
-- Check loaded data
SELECT 
    SYMBOL_ID,
    SYMBOL,
    NAME,
    MARKET_CAPITALIZATION,
    SECTOR,
    LOADED_AT
FROM OVERVIEW 
ORDER BY LOADED_AT DESC;
```

## Expected Results

After successful setup:
- ✅ Lambda functions generate CSV files in S3
- ✅ S3 events trigger Snowpipes automatically  
- ✅ CSV data loads into Snowflake tables within minutes
- ✅ Data available for analytics queries and BI tools
- ✅ End-to-end pipeline: Lambda → S3 → Snowflake

## Cost Optimization

- Warehouse auto-suspends after 1 minute of inactivity
- X-SMALL warehouse (1 credit/hour when active)
- Snowpipes run serverlessly (charged per compute second)
- Clustered tables optimize query performance